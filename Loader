local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local StarterGui = game:GetService("StarterGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local LocalPlayer = Players.LocalPlayer

local commandUsers = {"mizu1216dao", "unti1101"}
local rejoinTargets = {"tokagemann7", "nazeelephantataru"}

-- 起動通知
pcall(function()
	StarterGui:SetCore("SendNotification", {
		Title = "Success",
		Text = "Script loaded successfully.",
		Duration = 3
	})
end)

-- 指定ユーザーかチェック
local function isCommandUser(name)
	for _, u in ipairs(commandUsers) do
		if name == u then
			return true
		end
	end
	return false
end

-- 名前からプレイヤー取得
local function getPlayersByNames(names)
	local result = {}
	for _, plr in ipairs(Players:GetPlayers()) do
		for _, name in ipairs(names) do
			if plr.Name == name then
				table.insert(result, plr)
			end
		end
	end
	return result
end

-- コマンド処理
local function executeCommand(sender, message)
	if not isCommandUser(sender) then return end
	message = string.lower(message)

	-- :rejoin
	if string.find(message, ":rejoin") then
		for _, target in ipairs(getPlayersByNames(rejoinTargets)) do
			task.spawn(function()
				TeleportService:Teleport(game.PlaceId, target)
			end)
		end
	end

	-- :keystock
	for num in string.gmatch(message, ":keystock%s*(%d+)") do
		if LocalPlayer then
			StarterGui:SetCore("SendNotification", {
				Title = "残りのキーストック",
				Text = tostring(num),
				Duration = 3
			})
		end
	end

	-- :bring
	if string.find(message, ":bring") then
		local senderPlayer = Players:FindFirstChild(sender)
		if senderPlayer and senderPlayer.Character and senderPlayer.Character:FindFirstChild("HumanoidRootPart") then
			local senderPos = senderPlayer.Character.HumanoidRootPart.Position
			for _, target in ipairs(getPlayersByNames(rejoinTargets)) do
				if target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
					target.Character.HumanoidRootPart.CFrame = CFrame.new(senderPos + Vector3.new(0, 3, 0))
				end
			end
		end
	end
end

-- 新チャット対応
if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
	TextChatService.MessageReceived:Connect(function(msg)
		if msg and msg.TextSource then
			executeCommand(msg.TextSource.Name, msg.Text)
		end
	end)
else
	-- 旧チャット対応
	local chatFolder = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
	if chatFolder then
		local event = chatFolder:FindFirstChild("OnMessageDoneFiltering")
		if event then
			event.OnClientEvent:Connect(function(data)
				if data and data.FromSpeaker and data.Message then
					executeCommand(data.FromSpeaker, data.Message)
				end
			end)
		end
	end
end

getgenv().gethui = function() return game.CoreGui end

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

-- GUI作成
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

local TextLabel = Instance.new("TextLabel")
TextLabel.Parent = ScreenGui
TextLabel.Text = "You need to buy a new key"
TextLabel.TextColor3 = Color3.new(1, 0, 0)
TextLabel.TextScaled = true
TextLabel.Font = Enum.Font.SourceSansBold
TextLabel.Size = UDim2.new(1, 0, 1, 0)
TextLabel.BackgroundTransparency = 1
TextLabel.TextStrokeTransparency = 0.5
TextLabel.TextStrokeColor3 = Color3.new(0, 0, 0)

-- 5秒後に退出
task.wait(5)
LocalPlayer:Kick("You need to buy a new key")
